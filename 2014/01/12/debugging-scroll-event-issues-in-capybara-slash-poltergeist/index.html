
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Debugging Scroll Event Issues in Capybara/Poltergeist - Louis Simoneau</title>
  <meta name="author" content="Louis Simoneau">

  
  <meta name="description" content="I came across a particularly tricky issue with one of my integration tests using capybara and poltergeist this week, so I thought I&rsquo;d write it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lsimoneau.github.io/2014/01/12/debugging-scroll-event-issues-in-capybara-slash-poltergeist">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Louis Simoneau" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Louis Simoneau</a></h1>
  
    <h2>Ruby, OOP, TDD, Remote Work, Miscellany</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lsimoneau.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Debugging Scroll Event Issues in Capybara/Poltergeist</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-12T08:22:00+08:00" pubdate data-updated="true">Jan 12<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I came across a particularly tricky issue with one of my integration tests using <a href="https://github.com/jnicklas/capybara">capybara</a> and <a href="https://github.com/jonleighton/poltergeist">poltergeist</a> this week, so I thought I&rsquo;d write it up for the benefit of anyone else encountering a similar problem.</p>

<h2>The Issue</h2>

<p>A key step in the workflow under test was clicking on a &ldquo;Publish&rdquo; button located at the bottom of the page. This test had been passing for some time, but started failing when we added a floating toolbar to the site.</p>

<p>The toolbar was of the type that appears as part of the document layout until the user scrolls past it, at which point it attaches itself to the top of the viewport.</p>

<p>The original code for the toolbar looked something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nv">toolbar = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;.toolbar&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">header  = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;.header&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nv">start   = </span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s">&quot;scroll&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nv">pos = </span><span class="nb">parseInt</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">toolbar</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&quot;position&quot;</span><span class="p">,</span> <span class="k">if</span> <span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">start</span> <span class="k">then</span> <span class="s">&quot;fixed&quot;</span> <span class="k">else</span> <span class="s">&quot;static&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">header</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&quot;padding-bottom&quot;</span><span class="p">,</span> <span class="k">if</span> <span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">start</span> <span class="k">then</span> <span class="nx">toolbar</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>When scrolling past the toolbar, the <code>position</code> attribute is switched from <code>static</code> to <code>fixed</code>. Because this yanks the content in the toolbar out of the document flow, it causes the rest of the page to jump upwards to fill the now-empty space, so we apply padding to the header equal to the toolbar&rsquo;s height to compensate.</p>

<p>With this code in place, the test started failing. Some quick debugging showed that the click on the publish button just wasn&rsquo;t happening (no <code>click</code> events were fired). Usually, if Capybara can&rsquo;t find the element you&rsquo;ve told it to click on, it will throw an error, but in this case it was just failing silently. Remove the fixed toolbar, test goes green again.</p>

<h2>The Solution</h2>

<p>The key insight towards solving this issue came when I added debug code to the <code>scroll</code> event handler shown above. The page was actually scrolling during the execution of the test.</p>

<p><a href="https://github.com/jonleighton/poltergeist#mouseeventfailed-errors">Poltergeist&rsquo;s documentation</a> explains why:</p>

<blockquote><p>When Poltergeist clicks on an element, rather than generating a DOM click event, it actually generates a &ldquo;proper&rdquo; click. This is much closer to what happens when a real user clicks on the page &ndash; but it means that Poltergeist must scroll the page to where the element is, and work out the correct co-ordinates to click. If the element is covered up by another element, the click will fail (this is a good thing &ndash; because your user won&rsquo;t be able to click a covered up element either).</p></blockquote>

<p>The problem arises because of the way the fixed toolbar is implemented: <em>first</em> it pulls the toolbar out of the document flow, <em>then</em> it compensates with padding.</p>

<p>This results in two page redraws, and an imperceptibly fast jitter in the position of elements on the page. But since poltergeist is operating much faster than a human with a mouse, the time delay between scrolling the page and clicking the button (or, more accurately, clicking the coordinates where it expects the button to be) is negligible. As a result, it clicks while the page is jumping and misses the button.</p>

<p>There are a number of possible fixes here. It&rsquo;s possible to tell Poltergeist to just trigger a click event on the element rather than scrolling to it and clicking on its coordinates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">find_button</span><span class="p">(</span><span class="s2">&quot;Save&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">click_button</span> <span class="s2">&quot;Save&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This solves the problem, but does away with one of the main benefits of using Poltergeist in the first place: it directly emulates the behavior of a user navigation the site. If an element is covered up by something else, Poltergeist will be unable to click on it, just like a user.</p>

<p>The solution I ended up with was to change the implementation: rather than apply CSS to two different elements in quick succession, I apply a class to the page body. Because the padding is variable and needs to be toggled on and off in CSS only, I moved it to a shim element that&rsquo;s hidden by default. The body class both applies <code>fixed</code> position <em>and</em> unhides the shim:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">shim    = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;.scroll-shim&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nv">toolbar = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;.toolbar&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nv">start   = </span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s">&quot;scroll&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nv">pos = </span><span class="nb">parseInt</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">shim</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&quot;padding-bottom&quot;</span><span class="p">,</span> <span class="nx">toolbar</span><span class="p">.</span><span class="nx">height</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s">&#39;scrolling-header&#39;</span><span class="p">,</span> <span class="nx">pos</span> <span class="o">&gt;</span> <span class="nx">start</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in CSS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="p">.</span><span class="nx">scroll</span><span class="o">-</span><span class="nx">shim</span> <span class="p">{</span>
</span><span class='line'>  <span class="nv">display: </span><span class="nx">none</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">.</span><span class="nx">toolbar</span> <span class="p">{</span>
</span><span class='line'>  <span class="nv">position: </span><span class="nx">static</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">.</span><span class="nx">scrolling</span><span class="o">-</span><span class="nx">header</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">scroll</span><span class="o">-</span><span class="nx">shim</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">display: </span><span class="nx">block</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">.</span><span class="nx">toolbar</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">position: </span><span class="nx">fixed</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because it only redraws the page once, this version doesn&rsquo;t cause content to jump around and allows Poltergeist to click on the button without issue. Although there&rsquo;s no perceptible difference when viewing the page, it <em>is</em> actually requiring the browser to do a bit less work, so it&rsquo;s even hypothetically possible that on slow hardware a user might see the benefit as well.</p>

<h2>Summary</h2>

<p>When using Poltergeist in combination with any JavaScript code that triggers off of <code>scroll</code> events, it&rsquo;s important to keep in mind that Poltergeist <em>will</em> scroll the page when required to get to an element you&rsquo;ve asked it to interact with. This isn&rsquo;t a bug, it&rsquo;s a feature: it allows for a closer emulation of a user interacting with your site, and might enable you to pick up issues that other drivers wouldn&rsquo;t surface.</p>

<p>However, if you&rsquo;re modifying the page in response to scroll events, you run the risk of introducing subtle race conditions like the one I&rsquo;ve described. In this particular case, there was a solution that improved both the performance of the page <em>and</em> the test behavior.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Louis Simoneau</span></span>

      








  


<time datetime="2014-01-12T08:22:00+08:00" pubdate data-updated="true">Jan 12<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/tdd/'>TDD</a>, <a class='category' href='/blog/categories/capybara/'>capybara</a>, <a class='category' href='/blog/categories/rails/'>rails</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://lsimoneau.github.io/2014/01/12/debugging-scroll-event-issues-in-capybara-slash-poltergeist/" data-via="louis_simoneau" data-counturl="http://lsimoneau.github.io/2014/01/12/debugging-scroll-event-issues-in-capybara-slash-poltergeist/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2013/10/25/whats-the-worst-mistake-im-empowered-to-make/" title="Previous Post: What’s the worst mistake I’m empowered to make?">&laquo; What’s the worst mistake I’m empowered to make?</a>
      
      
        <a class="basic-alignment right" href="/2014/05/03/tdd-saved-my-life-or-at-least-my-job/" title="Next Post: TDD Saved my Life (or at Least my Job)">TDD Saved my Life (or at Least my Job) &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/05/03/tdd-saved-my-life-or-at-least-my-job/">TDD Saved My Life (or at Least My Job)</a>
      </li>
    
      <li class="post">
        <a href="/2014/01/12/debugging-scroll-event-issues-in-capybara-slash-poltergeist/">Debugging Scroll Event Issues in Capybara/Poltergeist</a>
      </li>
    
      <li class="post">
        <a href="/2013/10/25/whats-the-worst-mistake-im-empowered-to-make/">What’s the Worst Mistake I’m Empowered to Make?</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/08/quarterly-reading-list-january-march-2013/">Quarterly Reading List: January-March 2013</a>
      </li>
    
      <li class="post">
        <a href="/2012/10/04/postgresql-system-trigger-error-with-rails/">PostgreSQL System Trigger Error With Rails</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/lsimoneau">@lsimoneau</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'lsimoneau',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/109414531358542644965?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Louis Simoneau -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'louissimoneau';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://lsimoneau.github.io/2014/01/12/debugging-scroll-event-issues-in-capybara-slash-poltergeist/';
        var disqus_url = 'http://lsimoneau.github.io/2014/01/12/debugging-scroll-event-issues-in-capybara-slash-poltergeist/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
